# ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©æ›¸

ShogiProjectã§ã¯DynamoDBã®Single Table Designã‚’æ¡ç”¨ã—ã€1ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

## ğŸ—ï¸ è¨­è¨ˆæ–¹é‡

### Single Table Designã®æ¡ç”¨ç†ç”±

- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: è¤‡é›‘ãªJOINã‚¯ã‚¨ãƒªã‚’é¿ã‘ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã‚’æœ€é©åŒ–
- **ã‚³ã‚¹ãƒˆåŠ¹ç‡**: ãƒ†ãƒ¼ãƒ–ãƒ«æ•°ã‚’å‰Šæ¸›ã—ã¦DynamoDBèª²é‡‘ã‚’æœ€å°åŒ–
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã«æœ€é©åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿é…ç½®

### ã‚­ãƒ¼è¨­è¨ˆæˆ¦ç•¥

ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ã‚’ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§è­˜åˆ¥ã—ã€åŠ¹ç‡çš„ãªã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿç¾ï¼š

- `kifu#uname#<username>` - ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥æ£‹è­œç®¡ç†
- `tag#uname#<username>` - ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¿ã‚°ç®¡ç†
- `analysis#<id>` - AIè§£æçµæœ
- `users#<username>` - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š

## ğŸ” ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ

**å…±é€šã‚­ãƒ¼ï¼ˆãƒ—ãƒ©ã‚¤ãƒãƒªã‚­ãƒ¼ï¼‰**: å…¨ã‚¢ã‚¤ãƒ†ãƒ ãŒå¿…é ˆã§æŒã¤å±æ€§
- `pk` (String): Partition Key - ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ã¨ã‚ªãƒ¼ãƒŠãƒ¼ã‚’è­˜åˆ¥
- `sk` (String): Sort Key - å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ IDã‚„è£œåŠ©æƒ…å ±ã‚’æ ¼ç´

### SwapIndex (GSI)
- **Partition Key**: `sk`, **Sort Key**: `pk`
- **Projection**: ALL
- **ç›®çš„**: IDé€†å¼•ãæ¤œç´¢ãƒ»ä¸€æ„æ€§åˆ¶ç´„
- **ç”¨é€”**:
  - ã‚·ã‚§ã‚¢ã‚³ãƒ¼ãƒ‰ã‹ã‚‰æ£‹è­œå–å¾—
  - ã‚¿ã‚°ãŒä»˜ã„ãŸæ£‹è­œä¸€è¦§
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç¢ºèª

### CommonGSI (GSI)
- **Partition Key**: `cgsi_pk`, **Sort Key**: `sk`
- **Projection**: ALL
- **ç›®çš„**: å…±æœ‰ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹
- **ç”¨é€”**:
  - å…±æœ‰æ£‹è­œã‚¢ã‚¯ã‚»ã‚¹
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è§£æä¸€è¦§

### CommonLSI (LSI)
- **Partition Key**: `pk`, **Sort Key**: `clsi_sk`
- **Projection**: INCLUDE (`cgsi_pk`, `clsi_sk`)
- **ç›®çš„**: åå‰ãƒ»ã‚¹ãƒ©ã‚°æ¤œç´¢
- **ç”¨é€”**:
  - ã‚«ã‚¹ã‚¿ãƒ URLæ¤œç´¢
  - ã‚¿ã‚°åæ¤œç´¢ãƒ»é‡è¤‡ãƒã‚§ãƒƒã‚¯

### CreatedIndex (LSI)
- **Partition Key**: `pk`, **Sort Key**: `created`
- **Projection**: INCLUDE (`cgsi_pk`, `clsi_sk`, `share`)
- **ç›®çš„**: ä½œæˆæ—¥æ™‚é †ã‚½ãƒ¼ãƒˆ
- **ç”¨é€”**: æ£‹è­œãƒ»ã‚¿ã‚°ã®ä½œæˆæ—¥æ™‚é †ãƒªã‚¹ãƒˆè¡¨ç¤º

### LatestAccessIndex (LSI)
- **Partition Key**: `pk`, **Sort Key**: `latest_access`
- **Projection**: INCLUDE (`cgsi_pk`, `clsi_sk`, `share`)
- **ç›®çš„**: ã‚¢ã‚¯ã‚»ã‚¹æ—¥æ™‚é †ã‚½ãƒ¼ãƒˆ
- **ç”¨é€”**: ã‚ˆãã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹æ£‹è­œã®è¡¨ç¤º

### LatestUpdateIndex (LSI)
- **Partition Key**: `pk`, **Sort Key**: `latest_update`
- **Projection**: INCLUDE (`cgsi_pk`, `clsi_sk`, `share`)
- **ç›®çš„**: æ›´æ–°æ—¥æ™‚é †ã‚½ãƒ¼ãƒˆ
- **ç”¨é€”**: æœ€è¿‘æ›´æ–°ã•ã‚ŒãŸæ£‹è­œã®è¡¨ç¤º

## ğŸ“‹ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä¸€è¦§

DynamoDBã®ç‰¹æ€§ä¸Šã€å„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆã‚¢ã‚¤ãƒ†ãƒ ï¼‰ã¯ç•°ãªã‚‹å±æ€§ã‚»ãƒƒãƒˆã‚’æŒã¡ã¾ã™ã€‚ä»¥ä¸‹ã¯ä¸»è¦ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¿ã‚¤ãƒ—ã¨ãã®å±æ€§æ§‹æˆã§ã™ã€‚

### 1. æ£‹è­œã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
**ã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³**: `pk=kifu#uname#<username>`, `sk=kid#<kifu_id>`

| å±æ€§å | ãƒ‡ãƒ¼ã‚¿å‹ | èª¬æ˜ |
|-------|---------|------|
| `cgsi_pk` | String | `kifu#scode#<share_code>` |
| `clsi_sk` | String | `slug#<custom_slug>` |
| `kifu` | String | æ£‹è­œãƒ‡ãƒ¼ã‚¿ (KIF/KI2å½¢å¼) |
| `first_or_second` | String | å…ˆæ‰‹/å¾Œæ‰‹ (`first`/`second`) |
| `result` | String | å¯¾å±€çµæœ (`win`/`lose`/`draw`/`sennichite`) |
| `memo` | String | æ£‹è­œãƒ¡ãƒ¢ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆ |
| `public` | Boolean | å…¬é–‹è¨­å®š |
| `share` | Boolean | å…±æœ‰å¯èƒ½è¨­å®š |
| `created` | String | ä½œæˆæ—¥æ™‚ (ISO 8601) |
| `latest_access` | String | æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹æ—¥æ™‚ |
| `latest_update` | String | æœ€çµ‚æ›´æ–°æ—¥æ™‚ |

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
**ã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³**: `pk=users`, `sk=uname#<username>`

| å±æ€§å | ãƒ‡ãƒ¼ã‚¿å‹ | èª¬æ˜ |
|-------|---------|------|
| `kifu_max` | Number | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ£‹è­œæœ€å¤§ID |
| `tag_max` | Number | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚°æœ€å¤§ID |

### 3. ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
**ã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³**: `pk=system`, `sk=none`

| å±æ€§å | ãƒ‡ãƒ¼ã‚¿å‹ | èª¬æ˜ |
|-------|---------|------|
| `kifu_max` | Number | ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®æ£‹è­œæœ€å¤§ID |
| `tag_max` | Number | ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ã‚¿ã‚°æœ€å¤§ID |

### 4. ã‚¿ã‚°å®šç¾©ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
**ã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³**: `pk=tag#uname#<username>`, `sk=tid#<tag_id>`

| å±æ€§å | ãƒ‡ãƒ¼ã‚¿å‹ | èª¬æ˜ |
|-------|---------|------|
| `clsi_sk` | String | `tname#<tag_name>` |
| `created` | String | ä½œæˆæ—¥æ™‚ (ISO 8601) |
| `latest_access` | String | æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹æ—¥æ™‚ |
| `latest_update` | String | æœ€çµ‚æ›´æ–°æ—¥æ™‚ |

### 5. æ£‹è­œ-ã‚¿ã‚°é–¢é€£ä»˜ã‘ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
**ã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³**: `pk=tag#kid#<kifu_id>`, `sk=tid#<tag_id>`

*å…±é€šå±æ€§ã®ã¿*

### 6. æ£‹è­œã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
**ã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³**: `pk=kallowed#kid#<kifu_id>`, `sk=uname#<username>`

*å…±é€šå±æ€§ã®ã¿*

### 7. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¨ä½“ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
**ã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³**: `pk=uallowed#uname#<username>`, `sk=uname#<allowed_username>`

*å…±é€šå±æ€§ã®ã¿*

### 8. AIè§£æçµæœã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
**ã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³**: `pk=analysis`, `sk=aid#<analysis_id>`

| å±æ€§å | ãƒ‡ãƒ¼ã‚¿å‹ | èª¬æ˜ |
|-------|---------|------|
| `cgsi_pk` | String | `analysis#uname#<username>` |
| `created` | String | ä½œæˆæ—¥æ™‚ (ISO 8601) |
| `status` | String | è§£æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (`waiting`/`succeeded`/`error`) |
| `response` | String | è§£æçµæœãƒ»ã‚¨ãƒ©ãƒ¼è©³ç´° |
| `expired` | Number | TTL (Unix timestamp) |

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¿ãƒ¼ãƒ³ä¾‹

### 1. æ£‹è­œãƒ‡ãƒ¼ã‚¿
```json
{
  "pk": "kifu#uname#h-akira",
  "sk": "kid#fdsaj9d9s0",
  "cgsi_pk": "kifu#scode#lkihofkwif4tF",
  "clsi_sk": "slug#ç¤¾å›£æˆ¦/2025/éˆ´æœ¨",
  "kifu": "æ‰‹åˆå‰²ï¼šå¹³æ‰‹\nå…ˆæ‰‹ï¼š...",
  "first_or_second": "first",
  "result": "sennichite",
  "memo": "åºç›¤ç ”ç©¶ç”¨ã®æ£‹è­œ",
  "public": true,
  "share": true,
  "created": "2025-12-31T11:11:31Z",
  "latest_access": "2025-12-31T11:11:31Z",
  "latest_update": "2025-12-31T11:11:31Z"
}
```

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
```json
{
  "pk": "users",
  "sk": "uname#h-akira",
  "kifu_max": 3000,
  "tag_max": 50
}
```

### 3. ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
```json
{
  "pk": "system",
  "sk": "none",
  "kifu_max": 3000,
  "tag_max": 50
}
```

### 4. ã‚¿ã‚°å®šç¾©
```json
{
  "pk": "tag#uname#h-akira",
  "sk": "tid#jko2kdl",
  "clsi_sk": "tname#å››é–“é£›è»Š",
  "created": "2025-12-31T11:11:31Z",
  "latest_access": "2025-12-31T11:11:31Z",
  "latest_update": "2025-12-31T11:11:31Z"
}
```

### 5. æ£‹è­œ-ã‚¿ã‚°é–¢é€£ä»˜ã‘
```json
{
  "pk": "tag#kid#fdsaj9d9s1",
  "sk": "tid#jko2kdl"
}
```

### 6. æ£‹è­œã‚¢ã‚¯ã‚»ã‚¹æ¨©é™
```json
{
  "pk": "kallowed#kid#fdsaj9d9s1",
  "sk": "uname#h-akira2"
}
```

### 7. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¨ä½“ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™
```json
{
  "pk": "uallowed#uname#h-akira",
  "sk": "uname#h-akira2"
}
```

### 8. AIè§£æçµæœ
```json
{
  "pk": "analysis",
  "sk": "aid#fdjsklfadf",
  "cgsi_pk": "analysis#uname#h-akira",
  "created": "2025-12-31T11:11:31Z",
  "status": "succeeded",
  "response": "{\"moves\": [...], \"evaluation\": [...]}",
  "expired": 1234567890
}
```

## ğŸ”§ ä¸»ãªã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ£‹è­œä¸€è¦§å–å¾—
```python
# ä½œæˆæ—¥æ™‚é †
response = table.query(
    IndexName='CreatedIndex',
    KeyConditionExpression=Key('pk').eq('kifu#uname#h-akira')
)
```

### 2. å…±æœ‰æ£‹è­œã®å–å¾—
```python
# ã‚·ã‚§ã‚¢ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å–å¾—
response = table.query(
    IndexName='SwapIndex',
    KeyConditionExpression=Key('sk').eq('kifu#scode#ABC123')
)
```

### 3. ã‚¿ã‚°æ¤œç´¢
```python
# ã‚¿ã‚°åã§ã®æ¤œç´¢
response = table.query(
    IndexName='CommonLSI',
    KeyConditionExpression=Key('pk').eq('tag#uname#h-akira') &
                          Key('clsi_sk').begins_with('tname#å››é–“é£›è»Š')
)
```

### 4. è§£æçŠ¶æ³ç¢ºèª
```python
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è§£æãƒªã‚¹ãƒˆ
response = table.query(
    IndexName='CommonGSI',
    KeyConditionExpression=Key('cgsi_pk').eq('analysis#uname#h-akira')
)
```

## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …

### ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£å¯¾ç­–

1. **Partitionåˆ†æ•£**: å°†æ¥çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°å¢—åŠ æ™‚ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ãƒãƒƒã‚·ãƒ¥å€¤ã§Partitionã‚’åˆ†æ•£
2. **Hot Partitionå›é¿**: ã‚¢ã‚¯ã‚»ã‚¹é »åº¦ã®é«˜ã„ãƒ‡ãƒ¼ã‚¿ã¯é©åˆ‡ã«åˆ†æ•£é…ç½®
3. **ãƒãƒƒãƒå‡¦ç†**: å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†æ™‚ã¯DynamoDB Streamsã‚„ETLãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ´»ç”¨

### æœ€é©åŒ–ãƒã‚¤ãƒ³ãƒˆ

- **Project Type**: å¿…è¦ãªå±æ€§ã®ã¿ã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å«ã‚ã¦ã‚³ã‚¹ãƒˆå‰Šæ¸›
- **TTLæ´»ç”¨**: è§£æçµæœãªã©ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•å‰Šé™¤
- **Consistent Read**: å¼·æ•´åˆæ€§ãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹ã§ã®ã¿ä½¿ç”¨

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µæˆ¦ç•¥ï¼š

1. **å¾Œæ–¹äº’æ›æ€§**: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¶­æŒ
2. **æ®µéšçš„ç§»è¡Œ**: æ–°æ—§ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®ä¸¦è¡Œé‹ç”¨
3. **ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°**: ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†

---

**æ³¨æ„**: æœ¬è¨­è¨ˆã¯ç¾åœ¨ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã«æœ€é©åŒ–ã•ã‚Œã¦ãŠã‚Šã€è¦ä»¶å¤‰æ›´æ™‚ã¯é©å®œè¦‹ç›´ã—ãŒå¿…è¦ã§ã™ã€‚